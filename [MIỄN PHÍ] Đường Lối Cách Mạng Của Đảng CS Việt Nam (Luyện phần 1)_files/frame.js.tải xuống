"use strict";import{APP_COMPONENT,APP_EVENT,BBCODE_REGEX,URL_REGEX,DEFAULT_FAVICON}from './lib/enums.js';(function(PubSub,BBCodeHTML){const app={state:{currentScreen:'conversation',timeOuts:[],ogData:null,clearTimeout:function(){this.timeOuts.forEach((item,index,object)=>{clearTimeout(item);object.splice(index,1);});}},animation:{disable:false,slideOutLeft:{opacity:'hide',left:'-=50',right:'50',},slideIn:{opacity:'show',left:'0',right:'0',},slideOutRight:{opacity:'hide',right:'-=50',left:'50',},showHeaderAgentMini:function(duration=100){app.component.headerMoreBtn.getComponent().hide();app.component.headerAgentFull.getComponent().hide();app.component.headerAgentMini.getComponent().fadeIn(duration);},hideHeaderAgentMini:function(duration=100){app.component.headerMoreBtn.getComponent().fadeIn(duration);app.component.headerAgentFull.getComponent().fadeIn(duration);app.component.headerAgentMini.getComponent().hide();},},navigate:function(screenName,duration=300){let currentScreen=this.state.currentScreen;this.screen[currentScreen].hide(duration);this.screen[screenName].show(duration);this.state.currentScreen=screenName;setTimeout(()=>{PubSub.emit(APP_EVENT.SCREEN_CHANGE,screenName);},duration);},component:{header:{setHeight:function(height){const $component=this.getComponent();return $component.css('height',height);},getComponent:()=>$('.fff-messenger-header')},footer:{show:function(duration='fast'){const $component=this.getComponent();$component.animate({bottom:0,opacity:1},duration);},hide:function(duration='fast',callback=null){const $component=this.getComponent();$component.animate({bottom:'-=50',opacity:0},duration,callback);},getComponent:()=>$('.fff-messenger-footer-wrapper')},textarea:{getComponent:()=>$('.fff-messenger-body-conversation--footer-wrapper textarea')},headerAgentMini:{getComponent:()=>$('.fff-messenger-header-mini')},headerAgentFull:{getComponent:()=>$('.fff-messenger-header-full')},headerMoreBtn:{getComponent:()=>$('.fff-messenger-header-more-button')},form:{input:function({type,name,placeholder,classes=''}){if(type==='textarea')return $(`<textarea rows="5" name="${name}" placeholder="${placeholder}*" class="fff_input ${classes}"></textarea>`)
return $(`<input type="${type}" name="${name}" placeholder="${placeholder}*" class="fff_input ${classes}" autocomplete="off" />`)},show:function(options={}){const $textarea=app.component.textarea.getComponent();$textarea.attr('disabled','disabled')
const $form=$('<form class="fff_form"><div></div></form>').hide()
if(options.content)$form.find('div').append('<p>'+options.content+'</p>')
const $button=$('<div class="fff_button">Bắt đầu chat</div>').click(()=>{let is_focus=false;options.inputs.forEach($input=>{if($input.val().trim())return
if(is_focus)return
$input.focus();$input.addClass('error')
is_focus=true;})
if(is_focus||options.domain==='demochat.fff.com.vn')return
const data=$form.serializeArray();this.submit(data,options.uuid,options.ownerId);options.onSubmit({name:(data.find(i=>i.name==='name')||{value:''}).value,phone:(data.find(i=>i.name==='phone')||{value:''}).value.replace('+',''),email:(data.find(i=>i.name==='email')||{value:''}).value,content:(data.find(i=>i.name==='content')||{value:''}).value,});$form.remove()
$textarea.attr('disabled',false)})
options.inputs.forEach($input=>$input.appendTo($form.find('div')).on('input',function(){if(!$(this).val().trim()){$(this).addClass("error");}else{$(this).removeClass("error");}}).keypress(function(event){if(event.key==="Enter"){$button.trigger('click')}}))
$button.appendTo($form.find('div'))
$form.insertBefore(app.screen.conversation.component.body.getComponent()).delay(1000).fadeIn()},submit:function(data,uuid,ownerId){var logClick={};logClick.widgetType='widgetChatBox';logClick.logType="logLead";logClick.nnn=(data.find(i=>i.name==='name')||{value:''}).value;logClick.ppp=(data.find(i=>i.name==='phone')||{value:''}).value.replace('+','');logClick.eee=(data.find(i=>i.name==='content')||{value:''}).value;parent.postMessage(logClick,"*");}}},screen:{home:{show:function(duration){for(const name in this.component){if(this.component.hasOwnProperty(name)){this.component[name].parent=this;}}
this.component.header.show(duration);this.component.body.show();this.component.bodyWrapper.show(duration);app.screen.loading.hide(100);app.state.timeOuts.push(setTimeout(()=>{app.component.footer.show('slow');},1000));},hide:function(duration){const bodyWrapper=this.component.bodyWrapper;bodyWrapper.hide(duration);this.component.header.hide(duration,function(){$(this).find('.animated').removeClass('animated');bodyWrapper.getComponent().find('.animated').removeClass('animated');});app.component.header.setHeight(75);app.animation.showHeaderAgentMini();app.component.footer.hide();},component:{header:{show:function(duration=300,callback=null){app.state.clearTimeout();setTimeout(()=>{this.calculateHeaderHeight();const $component=this.getComponent();$component.css('opacity',1);setTimeout(()=>{$component.css('left',-50).css('right',50).animate(app.animation.slideIn,duration,callback);},duration);},0);},hide:function(duration=300,callback=null){const $component=this.getComponent();$component.animate(app.animation.slideOutLeft,duration,callback);},getComponent:()=>$('.fff-messenger-header-wrapper-home'),calculateHeaderHeight:function(){const $header=this.getComponent();const height=Math.max($header.innerHeight(),$header.height());app.component.header.setHeight(height);}},body:{show:function(){setTimeout(()=>{this.calculateHeaderHeight();},0);},getComponent:()=>$('.fff-messenger-body-home-content'),calculateHeaderHeight:function(){const $header=app.screen.home.component.header.getComponent();const $body=this.getComponent();const height=Math.max($header.innerHeight(),$header.height());const offset=64;$body.css('padding-top',height-offset);}},calculateHeaderHeight:function(){this.header.calculateHeaderHeight();this.body.calculateHeaderHeight();},bodyWrapper:{show:function(duration=300,callback=null){const $component=this.getComponent();setTimeout(()=>{$component.css('left',-50).css('right',50).animate(app.animation.slideIn,duration);},duration);},hide:function(duration=300,callback=null){const $component=this.getComponent();$component.animate(app.animation.slideOutLeft,duration).scrollTop(0);},getComponent:()=>$('.fff-messenger-body-wrapper')},}},conversation:{show:function(duration){app.state.clearTimeout();const $bodyWrapper=this.component.bodyWrapper.getComponent();const $messageContainer=this.component.messageContainer.getComponent();const $headerAgentMini=app.component.headerAgentMini.getComponent();const{showHeaderAgentMini,hideHeaderAgentMini}=app.animation;setTimeout(()=>{this.component.header.show();this.component.body.show();const distance=$messageContainer.height();$bodyWrapper.scrollTop(distance);app.component.header.setHeight(165);hideHeaderAgentMini();},duration);$bodyWrapper.on('scroll',function(e){app.state.clearTimeout();const scrollTop=this.scrollTop;const hasScroll=this.scrollHeight>this.clientHeight;if(scrollTop>0){app.component.header.setHeight(75);showHeaderAgentMini();}else if(scrollTop==0&&hasScroll){app.state.timeOuts.push(setTimeout(()=>{app.component.header.setHeight(165);hideHeaderAgentMini();},1000));}})
$headerAgentMini.click(()=>{$bodyWrapper.scrollTop(0);app.component.header.setHeight(165);hideHeaderAgentMini();});},hide:function(duration){this.component.bodyWrapper.getComponent().off('scroll');this.component.body.hide(duration);this.component.header.hide(duration);},component:{body:{show:function(duration=300,callback=null){const $component=this.getComponent();$component.css('left',50).css('right',-50).animate(app.animation.slideIn,duration,callback);},hide:function(duration=300,callback=null){const $component=this.getComponent();$component.animate(app.animation.slideOutRight,duration,callback)},getComponent:()=>$('.fff-messenger-body-chat-content')},bodyWrapper:{getComponent:()=>$('.fff-messenger-body-conversation--wrapper')},header:{show:function(duration=300,callback=null){const $component=this.getComponent();$component.css('left',50).css('right',-50).animate(app.animation.slideIn,duration,callback);},hide:function(duration=300,callback=null){const $component=this.getComponent();$component.animate(app.animation.slideOutRight,duration,callback)},getComponent:()=>$('.fff-messenger-header-wrapper-conversation')},messageContainer:{getComponent:()=>$('.fff-messenger-body-conversation--message-container')},},scrollToBottom:function(duration=0,distance=100){const scrollTop=this.component.messageContainer.getComponent().height();this.component.bodyWrapper.getComponent().scrollTop(scrollTop-distance);this.component.bodyWrapper.getComponent().animate({scrollTop},duration);}},loading:{show:function(duration){},hide:function(duration){let $body=this.component.body();$body.fadeOut(duration);},component:{body:()=>$('.fff-messenger-body-loading'),}},},loadData:function(callback){let hasData=false;window.addEventListener('message',({data})=>{if(data.openChat){setTimeout(()=>{app.state.currentScreen==='home'&&app.screen.home.component.calculateHeaderHeight();},500);}
WebuiPopovers.hideAll();if(!hasData&&data.frameConfig){this.state.ogData=data.frameConfig;hasData=true;callback(data.frameConfig);}})
setTimeout(()=>{!hasData&&window.location.reload();},5000);},render:function(appData,mainTemplate){if(!appData)return
const _this=this;const renderConfig={parseTemplate:function(){const{show_close_btn,support_name,support_avatar,support_status_text,team_greeting,team_intro,header_logo,support_phone,support_email,support_messenger,support_telegram,support_twitter,header_theme,}=appData;let $mainFrame=$('.fff-messenger-frame');if(header_logo){mainTemplate=mainTemplate.replace(/{{ header_logo }}/g,`<img src="${header_logo}" />`);}
mainTemplate=mainTemplate.replace(/{{ team_greeting }}/g,team_greeting||_this.state.ogData.team_greeting).replace(/{{ team_intro }}/g,team_intro||_this.state.ogData.team_intro).replace(/{{ agentName }}/g,support_name||_this.state.ogData.support_name).replace(/{{ agentAvatar }}/g,`<img src="${support_avatar}" alt="${support_name}'s avatar">`).replace(/{{ agentStatusText }}/g,support_status_text||_this.state.ogData.support_status_text).replace(/{{ supportPhone }}/g,support_phone?`<a target="_blank" href="tel:${support_phone.replace(/ |\./g,'')}" class="fff-messenger-header-full--metadata phone" title="Gọi điện thoại"></a>`:'').replace(/{{ supportEmail }}/g,support_email?`<a target="_blank" href="mailto:${support_email}" class="fff-messenger-header-full--metadata mail" title="Gửi Email"></a>`:'').replace(/{{ supportMessenger }}/g,support_messenger?`<a target="_blank" href="//m.me/${support_messenger.replace('https://www.facebook.com/','')}" class="fff-messenger-header-full--metadata messenger" title="Nhắn tin Messenger"></a>`:'').replace(/{{ supportTelegram }}/g,support_telegram?`<a target="_blank" href="//t.me/${support_telegram.replace('https://t.me/','')}" class="fff-messenger-header-full--metadata telegram" title="Nhắn tin Telegram"></a>`:'').replace(/{{ supportTwitter }}/g,support_twitter?`<a target="_blank" href="//twitter.com/${support_twitter}" class="fff-messenger-header-full--metadata twitter" title="Nhắn tin Twitter"></a>`:'').replace(/{{ supportZalo }}/g,support_phone?`<a target="_blank" href="//zalo.me/${support_phone.replace(/ |\./g,'')}" class="fff-messenger-header-full--metadata zalo" title="Nhắn tin Zalo"></a>`:'').replace(/{{ headerTheme }}/g,'background-'+header_theme)
$mainFrame.html(mainTemplate);appData.domain==='demochat.fff.com.vn'&&$mainFrame.find('.animated').removeClass('animated')
appData.is_vip&&$mainFrame.find('.fff-messenger-footer, .fff-messenger-body-conversation--credit').remove();!header_logo&&$mainFrame.find('.fff-messenger-header-logo-brand').remove();if(show_close_btn)$mainFrame.addClass('show-close-btn');else $mainFrame.removeClass('show-close-btn');let $agentMetadata=$('.fff-messenger-header-full--metadata');$agentMetadata.tooltip({position:{my:"center bottom-5",at:"center top"},classes:{"ui-tooltip":""},show:{duration:100},hide:{duration:100},});},generateColor:function(){const Color=net.brehaut.Color;const colorFullHex=Color(appData.header_color);const colorRGB=[colorFullHex.getRed()*255,colorFullHex.getGreen()*255,colorFullHex.getBlue()*255];const colorShadeFullHex=colorFullHex.darkenByRatio(0.5);const colorTintFullHex=colorFullHex.darkenByRatio(0.3);const colorContrast=this._utils.getContrastColor(colorFullHex.toCSS());const{red,green,blue}=Color(colorContrast).toRGB();const colorContrastRGB=[red*255,green*255,blue*255];let customStyle={':root':{'--fff-color-primary':colorFullHex,'--fff-color-primary-rgb':colorRGB,'--fff-color-primary-shade':colorShadeFullHex,'--fff-color-primary-tint':colorTintFullHex,'--fff-color-primary-contrast':colorContrast,'--fff-color-primary-contrast-rgb':colorContrastRGB}}
this._utils.appendStyle(customStyle)},initActionSheet:function(){const actionSheetConfig={$btnTrigger:$('.fff-messenger-header-more-button'),target:"#fff_dropdown",items:[{text:"Bật nhận thông báo"},{text:"Thông tin liên hệ"},{text:"Dừng hội thoại",type:'danger'}],bindEvent:function(){},init:function(){let options={width:250,animation:'fade',padding:0,placement:'bottom-left',url:this.target,onShow:function($popover){},onHide:function($popover){},}
this.$btnTrigger.webuiPopover(options);this.bindEvent();}};},loadSocket:function(){_this.socketConfig={scriptUrl:'//c.trazk.com/widgets/smartChat/js/socket.io.js',FFF_SOCKET_URL:'//ws.fff.com.vn/smartchat',agentId:appData.domain,clientId:appData.uuid,support_name:appData.support_name,support_avatar:appData.support_avatar,$messageContainer:$('.fff-messenger-body-conversation--message-container-body'),calendarOptions:{sameDay:'[Hôm nay ·] HH:mm',lastDay:'[Hôm qua ·] HH:mm',lastWeek:'DD/MM/YYYY [·] HH:mm',sameElse:'DD/MM/YYYY [·] HH:mm'},connectChatSocket:function(){return io.connect(this.FFF_SOCKET_URL)},_loadScriptAsync:(uri,callback)=>{var tag=document.createElement('script');tag.src=uri;tag.async=true;tag.onload=callback;var firstScriptTag=document.getElementsByTagName('script')[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);},linkify:function(text){const urlRegex=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return text.replace(urlRegex,function(url){return `<a href="${url}" target="_blank">${url}</a>`;});},sentMessage:function(content,updateTime,onlyEmoji,onlyImg,onlyPreviewBox,parsedContent){return `
                            <div class="fff-messenger-body-conversation--message-wrapper">
                                <div class="fff-messenger-body-conversation--message-sent">
                                    <div class="fff-messenger-body-conversation--message-content${onlyEmoji?'-emoji':''} ${onlyImg?'only-img':''}">
                                        <div>${parsedContent}</div>
                                    </div>
                                </div>
                                <div class="fff-messenger-body-conversation--message-metadata">
                                    <div class="">
                                        ${updateTime}
                                    </div>
                                </div>
                            </div>`;},receivedMessage:function(agentAvatar,content,agentName,updateTime,onlyEmoji,onlyImg,onlyPreviewBox,parsedContent){return `
                            <div class="fff-messenger-body-conversation--message-wrapper">
                                <div class="fff-messenger-body-conversation--message-received">
                                    <div class="fff-messenger-body-conversation--message-avatar">
                                        <div
                                            class="fff-messenger-body-conversation--message-avatar-wrapper">
                                            <img src="${agentAvatar}"
                                                alt="${agentName}'s avatar">
                                        </div>
                                    </div>
                                    <div class="fff-messenger-body-conversation--message-content${onlyEmoji?'-emoji':''} ${onlyImg?'only-img':''}">
                                        <div>${parsedContent}</div>
                                    </div>
                                </div>
                                <div class="fff-messenger-body-conversation--message-metadata">
                                    <div class="">
                                        ${updateTime}
                                    </div>
                                </div>
                            </div>`;},isOnlyEmoji:function(content){var regex=/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/g;return content.length==2&&content.match(regex);},variableParser:function(content){const HTML_TAG_REGEX=new RegExp(/<script[\s\S]*?>[\s\S]*?<\/script>/gi);const scriptTags=content.match(HTML_TAG_REGEX);if(scriptTags&&scriptTags.length)scriptTags.forEach(tag=>content=content.replace(tag,tag.replace(/</g,"&lt;").replace(/>/g,"&gt;")));return content.replace(/\n/g,'<br/>').replace(/{{TEN_NHAN_VIEN}}/g,this.support_name);},parseContent:function(content){var bbcodeParser=new BBCodeHTML();var newContent=this.variableParser(content);var html=bbcodeParser.bbcodeToHtml(newContent);return html;},isOnlyImg:function(content){var a=document.createElement('div');a.innerHTML=content;return a.childNodes.length===1&&a.childNodes[0].nodeName.toLowerCase()==='img'},isOnlyPreviewBox:function(content){var tmp=document.createElement('div');tmp.innerHTML=content;return tmp.childElementCount===1&&tmp.firstElementChild&&tmp.firstElementChild.classList.contains('url-preview-box')},renderPreviewBox:function(data,url,$previewBox){if(data.nodata)return $previewBox.remove()
$previewBox.html(`<a target="_blank" href="${url}" class="url-preview-box"><div class="box-image">${data.video?'<iframe border="0" src="'+data.video+'" height="150"></iframe>':'<img height="'+(data['img-h']||data.thumbnail_height||150)+'" src="'+(data.img||data.thumbnail_url)+'" onerror="this.src=\'//themes.trazk.com/chat/assets/no.svg\'" />'}</div><div class="box-content"><div class="sub-title"><img src="${data.favicon||DEFAULT_FAVICON}" height="16" style="vertical-align:bottom" onerror="this.src='${DEFAULT_FAVICON}'" /> ${data.host||url}${data.author_name&&' · '+data.author_name||''}</div><div class="title">${data.title||'<i>Trang web này không có tiêu đề</i>'}</div>${data.description&&'<div class="sub-title">'+data.description+'</div>'||''}</div></a>`)},getUrlPreview:function(content,url,$appendMessage){const URL_PREVIEW='urlpreview_'+url;const $previewBox=$(`<div class="fff-messenger-body-conversation--message-content-preview-box">
                                <div class="url-preview-box">
                                    <div class="fff-loading" style="padding:16px">
                                        <div class="fff-spinner-wrapper">
                                            <div class="fff-spinner"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>`).insertAfter($appendMessage.find('.fff-messenger-body-conversation--message-content'))
let cacheData=JSON.parse(localStorage.getItem(URL_PREVIEW))
if(cacheData){this.renderPreviewBox(cacheData,url,$previewBox)}else axios.get(`https://guteurls.de/api/?u=${url}&t=json&r=https://fff.com.vn&e=support@fff.com.vn`).then(({data})=>{data.error&&console.log({data});this.renderPreviewBox(data,url,$previewBox);localStorage.setItem(URL_PREVIEW,JSON.stringify(data))}).catch((error)=>{console.log(error);})},addMessage:function(message){let{fromClient,content,time,name,avatar}=message;let $appendMessage;const updateTime=moment(time).calendar(null,this.calendarOptions);const urls=content.replace(BBCODE_REGEX,'').match(URL_REGEX);urls&&urls.forEach(u=>{content=content.replace(u,'[url]'+u.trim()+'[/url]')})
const template=this.parseContent(content);if(fromClient){$appendMessage=$(this.sentMessage(content,updateTime,this.isOnlyEmoji(template),this.isOnlyImg(template),this.isOnlyPreviewBox(template),template));}else{$appendMessage=$(this.receivedMessage(avatar,content,name,updateTime,this.isOnlyEmoji(template),this.isOnlyImg(template),this.isOnlyPreviewBox(template),template));}
$('[data-render="updateTime"]').text(updateTime);$('[data-render="lastMessage"]').text((fromClient?'Bạn: ':'')+content.replace(BBCODE_REGEX,content.indexOf('[img]')>-1?'[Hình ảnh]':'[Liên kết]'));this.$messageContainer.append($appendMessage);if(urls&&urls[0]){this.getUrlPreview(content,urls[0].trim(),$appendMessage)}
const _this=this;this.$messageContainer.find('div.fff-button').each(function(idx,ele){const $this=$(this);const btnContent=$this.text();$this.off('click');$this.on('click',()=>{if(btnContent.trim()){const $textarea=$(".fff-messenger-body-conversation--footer-wrapper textarea");const $btnSend=$(".fff-messenger-body-conversation--footer-wrapper-button-4");$textarea.val(btnContent);$btnSend.trigger('click');}});});},bindEvent:function(fff_chat_socket){const HTML_TAG_REGEX=new RegExp(/<script[\s\S]*?>[\s\S]*?<\/script>/gi);const eventConfig={$btnSend:$(".fff-messenger-body-conversation--footer-wrapper-button-4"),thuchienChatCoKhach:(noidung)=>{if(noidung.trim()!=''){_this.screen.conversation.scrollToBottom();var res={'content':noidung,'fromClient':1,'avatar':'//w.cokhach.com/assets/images/user.png','name':'','time':new Date().toISOString()}
this.addMessage(res);}},submitSoketChat:(noidung)=>{if(!noidung.trim())return;const scriptTags=noidung.match(HTML_TAG_REGEX);if(scriptTags&&scriptTags.length)scriptTags.forEach(tag=>noidung=noidung.replace(tag,tag.replace(/</g,"&lt;").replace(/>/g,"&gt;")));const random=Math.floor((Math.random()*50)+20)*200;let $ele=$(this.receivedMessage(this.support_avatar,'','','',false,false,false,'<div class="ticontainer" title="Đang nhập tin nhắn..."><div class="tiblock"><div class="tidot"></div><div class="tidot"></div><div class="tidot"></div></div></div>')).tooltip({position:{my:"center bottom-5",at:"center top"},classes:{"ui-tooltip":""},show:{duration:100},hide:{duration:100},});const $agentStatus=$('.fff-messenger-header-mini-wrapper--agent-status-text span')
setTimeout(()=>{$agentStatus.text('Đang nhập tin nhắn...')
this.$messageContainer.find('.ticontainer').parents('.fff-messenger-body-conversation--message-wrapper').remove();$ele.appendTo(this.$messageContainer);_this.screen.conversation.scrollToBottom();},random/2);setTimeout(()=>{fff_chat_socket.emit('chatmessage',{clientId:this.clientId,agentId:this.agentId,message:noidung});$ele.remove();$agentStatus.text('Đang trực tuyến')},random);},clearChatContent:()=>{app.component.textarea.getComponent().val('').trigger('input');},init:function(){const $textarea=app.component.textarea.getComponent();const handleClick=()=>{let noidung=$textarea.val();this.thuchienChatCoKhach(noidung);this.submitSoketChat(noidung);this.clearChatContent();};$textarea.keypress((event)=>{if(event.which==13){event.preventDefault();handleClick();}});this.$btnSend.click(handleClick);}};this.agentId!=='demochat.fff.com.vn'&&eventConfig.init();},init:function(){const unique=(array,prop)=>{let result=[];const map=new Map();for(const item of array){if(!map.has(item[prop])){map.set(item[prop],true);result.push(item);}else{result=result.map(i=>(i[prop]===item[prop]&&i['name'])?item:i)}}
return result}
const getMessages=(data)=>{let localMessages=JSON.parse(localStorage.getItem('chatmessage_'+this.agentId))
if(localMessages&&localMessages.messages)localStorage.setItem('chatmessage_'+this.agentId,JSON.stringify(localMessages.messages))
else if(data&&data.messages){localStorage.setItem('chatmessage_'+this.agentId,JSON.stringify(data.messages))
localMessages=data.messages}
return(data&&data.messages)||(localMessages&&localMessages.messages)||localMessages}
const $tempMessage=$('<p class="font-12 text-center color-medium margin-vertical">Đang tải tin nhắn mới...</p>')
const renderMessages=(data=null)=>{const messages=getMessages(data);if(messages&&messages.length>0){_this.screen.loading.hide(100);messages.forEach(message=>{if((message.agentId!==this.agentId)||message.content.startsWith('/note')||message.content.startsWith('/ghichu'))return;message.avatar=this.support_avatar;this.addMessage(message);});this.$messageContainer.show();_this.screen.conversation.scrollToBottom();}}
renderMessages()
$tempMessage.appendTo(this.$messageContainer);if(appData.productionMode){this._loadScriptAsync(this.scriptUrl,()=>{const fff_chat_socket=this.connectChatSocket();this.bindEvent(fff_chat_socket);fff_chat_socket.on('connect',()=>{let clientAvatar='https://w.cokhach.com/assets/images/user.png';if(!this.agentId)this.agentId=document.referrer.replace('http://','').replace('https://','').replace('www.','').split('/')[0];if(this.clientId!=''&&this.agentId!=''){fff_chat_socket.emit('connected',{clientId:this.clientId,agentId:this.agentId,support_name:this.support_name,clientAvatar:clientAvatar,support_avatar:this.support_avatar});}else{console.error('check clientId & agentId');}});fff_chat_socket.on('start-chat',()=>{this.$messageContainer.empty();});fff_chat_socket.on('chatmessage',renderMessages);fff_chat_socket.on('phone_detect',data=>{if(data&&data.phone_number){var logClick={};logClick.widgetType='widgetChatBox';logClick.logType="logLead";logClick.ppp=data.phone_number.replace("+","");parent.postMessage(logClick,"*");}});})}else{_this.screen.loading.hide(100);let message={agentId:this.agentId,avatar:this.support_avatar,clientId:this.clientId,content:"Anh (chị) cần em trợ giúp gì ạ: hướng dẫn đăng ký, giới thiệu sản phẩm, Anh (chị) cứ hỏi em nhé!",fromClient:0,name:this.support_name,time:new Date().toISOString(),}
this.addMessage(message);this.$messageContainer.show();}
$('.fff-messenger-card-body--message').fadeIn();}}
_this.socketConfig.init();},_utils:{getContrastColor:function(hex){if(hex.indexOf('#')===0){hex=hex.slice(1);}
if(hex.length===3){hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];}
if(hex.length!==6){throw new Error('Invalid HEX color.');}
var r=parseInt(hex.slice(0,2),16),g=parseInt(hex.slice(2,4),16),b=parseInt(hex.slice(4,6),16);return(r*0.299+g*0.587+b*0.114)>186?'#000000':'#FFFFFF';},appendStyle:function(listStyle){let head=document.getElementsByTagName('head')[0];let style=document.createElement('style');Object.keys(listStyle).forEach(className=>{let styles=listStyle[className];let css=className+'{';Object.keys(styles).forEach(styleAttr=>{let styleValue=styles[styleAttr];css+=`${styleAttr}:${styleValue};`});css+='}';if(style.styleSheet){style.styleSheet.cssText=css;}else{style.appendChild(document.createTextNode(css));}});style.type='text/css';style.rel='stylesheet';head.append(style);},getCookie:function(name){var value="; "+document.cookie;var parts=value.split("; "+name+"=");if(parts.length==2)return parts.pop().split(";").shift();}},init:function(){let isInitial=(mainTemplate==$('.fff-messenger-frame').html());this.parseTemplate();this.generateColor();this.initActionSheet();this.loadSocket();let screen=appData.open_conversation_first?'conversation':'home';_this.state.currentScreen=screen;_this.screen[screen].show(isInitial?300:0);setTimeout(()=>{if(appData.hide_header_mini)_this.component.headerAgentMini.getComponent().trigger('click');},100);if(appData.show_form&&appData.show_form!=='disable'&&appData.worktime){const format='HH:mm';const time=moment();const beforeTime=moment(appData.worktime.start||'00:00',format);const afterTime=moment(appData.worktime.end||'00:00',format);if(appData.domain!=='demochat.fff.com.vn'&&(appData.show_form==="out-of-business-hour"&&time.isBetween(beforeTime,afterTime)||(appData.parentCookie.nnn!=null||appData.parentCookie.eee!=null||appData.parentCookie.ppp!=null)))return
app.component.form.show({content:appData.form_header_text||'Bạn vui lòng điền thông tin vào mẫu dưới đây để bắt đầu trò chuyện',inputs:(appData.form_inputs&&appData.form_inputs.map(opts=>app.component.form.input(opts)))||[app.component.form.input({type:'text',name:'name',placeholder:'Tên của bạn'}),app.component.form.input({type:'tel',name:'phone',placeholder:'Số điện thoại'}),app.component.form.input({type:'email',name:'email',placeholder:'Email'}),app.component.form.input({type:'textarea',name:'content',placeholder:'Nội dung'}),],ownerId:appData.ownerId,uuid:appData.uuid,domain:appData.domain,onSubmit:(inputs)=>{const $textarea=$(".fff-messenger-body-conversation--footer-wrapper textarea");const $btnSend=$(".fff-messenger-body-conversation--footer-wrapper-button-4");const keys={name:'Tên',phone:'Điện thoại',email:'Email',content:'Nội dung',};let isFirst=true;let val=name?'Tên: '+name:'';for(const input in inputs){if(inputs.hasOwnProperty(input)){const value=inputs[input];if(value.trim())val+=((isFirst?'':'\n')+(keys[input]||input)+': '+value);isFirst=false;}}
$textarea.val(val);$btnSend.trigger('click');},})}}}
renderConfig.init();},bindEvent:function(){const $btnStartChat=$('.fff-messenger-card-content--button-wrapper button');const $itemConversation=$('.fff-messenger-card-body--conversation');const $btnBack=$('.fff-messenger-header-back-button')
const $textarea=this.component.textarea.getComponent();const $messageContainer=$('.fff-messenger-body-conversation--message-container-body');const $homeBody=this.screen.home.component.bodyWrapper.getComponent();const $btnGIF=$('.fff-messenger-body-conversation--footer-wrapper-button-1');const $btnSmile=$('.fff-messenger-body-conversation--footer-wrapper-button-2');const $btnAttachment=$('.fff-messenger-body-conversation--footer-wrapper-button-3');const $btnSend=$('.fff-messenger-body-conversation--footer-wrapper-button-4');const $preTag=$('.fff-messenger-body-conversation--footer-wrapper pre');const startChat=()=>{app.navigate('conversation')}
const goBack=()=>{app.navigate('home')}
$btnStartChat.click(startChat);$itemConversation.click(startChat);$btnBack.click(goBack);const formatString=(alias)=>{var str=alias;str=str.toLowerCase();str=str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a");str=str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e");str=str.replace(/ì|í|ị|ỉ|ĩ/g,"i");str=str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o");str=str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u");str=str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y");str=str.replace(/đ/g,"d");str=str.replace(/đ/g,"d");str=str.replace(/ /g,"");str=str.trim();return str;}
const handleImageUpload=(file,name='')=>{if(!name)name=formatString(file.name)
const formData=new FormData()
formData.append('file',file,name)
formData.append('name',name.split('.')[0])
formData.append('uuid',location.hostname)
var reader=new FileReader();let $preloadMessage;const _this=this;reader.onload=function(e){var image=new Image();image.src=e.target.result;image.onload=function(){var height=this.height;var width=this.width;$preloadMessage=$(_this.socketConfig.sentMessage('Loading...',moment().calendar(null,_this.socketConfig.calendarOptions),false,true,false,`<div class="fff_loading inline" style="width: ${width}px; height: ${height}px"><div class="fff_loading_wrapper"><div class="fff_loading_spinner"></div></div></div>`)).appendTo($messageContainer)};}
reader.readAsDataURL(file);fetch('//f.trazk.com/userfiles/v6-upload.php',{method:'POST',body:formData}).then(response=>response.json()).then(data=>{if($preloadMessage)$preloadMessage.remove();if(data.status==='success'||data.status==='exits'){const imageUrl=data.attachment;$textarea.val('[img]'+imageUrl+'[/img]');$btnSend.trigger('click');}else{console.error(data)}}).catch(error=>{console.error(error)})}
$textarea.on('input',(e)=>{const el=e.target;if(el.value&&el.value.trim()!=''){$btnAttachment.hide();$btnSend.show();}else{$btnAttachment.show();$btnSend.hide();}
setTimeout(()=>{$preTag.text(el.value);if(el.scrollHeight<=200&&el.scrollHeight>0)
this.screen.conversation.component.bodyWrapper.getComponent().css('bottom',el.scrollHeight);this.screen.conversation.scrollToBottom();},0);}).on('paste',function(event){var items=(event.clipboardData||event.originalEvent.clipboardData).items;for(var index in items){var item=items[index];if(item.kind==='file'){var file=item.getAsFile();handleImageUpload(file,formatString(file.lastModified+'.png'))}}}).trigger('input').focus();$homeBody.on('scroll',(e)=>{const target=this.screen.home.component.header.getComponent();const targetHeight=target.height();const scrollPercent=(targetHeight-e.target.scrollTop)/targetHeight;const translateY=e.target.scrollTop/4;target.css('opacity',scrollPercent>0?scrollPercent:0);target.css('transform',`translateY(${translateY>0?translateY*(-1):0}px)`);});const options=(opts,$btn,callback_onShow=()=>{},callback_onHide=()=>{})=>{return{animation:'fade',style:'custom',dismissible:true,...opts,onShow:function($popover){const $img=$btn.find('img');$img.attr('src',$img.data('src')+'-active.svg');callback_onShow($popover);},onHide:function($popover){const $img=$btn.find('img');$img.attr('src',$img.data('src')+'.svg');callback_onHide($popover);},}}
$btnSmile.webuiPopover(options({width:'80%',height:260,url:'//themes.trazk.com/chat/emoji.html',type:'async'},$btnSmile));$btnAttachment.change(function(event){handleImageUpload(event.target.files[0]);})},init:function(){if(!this.mainTemplate)this.mainTemplate=$('.fff-messenger-frame').html();this.loadData((data)=>{this.render(data,this.mainTemplate)
this.bindEvent();})}}
app.init();})(PubSub(),BBCodeHTML)
function PubSub(){return{events:{},on:function(eventName,fn){this.events[eventName]=this.events[eventName]||[];this.events[eventName].push(fn);},off:function(eventName,fn){if(this.events[eventName]){for(var i=0;i<this.events[eventName].length;i++){if(this.events[eventName][i]===fn){this.events[eventName].splice(i,1);break;}};}},emit:function(eventName,data){if(this.events[eventName]){this.events[eventName].forEach(function(fn){fn(data);});}}}};function BBCodeHTML(){var me=this;var token_match=/{[A-Z_]+[0-9]*}/ig;var tokens={'URL':'((?:(?:[a-z][a-z\\d+\\-.]*:\\/{2}(?:(?:[a-z0-9\\-._~\\!$&\'*+,;=:@|]+|%[\\dA-F]{2})+|[0-9.]+|\\[[a-z0-9.]+:[a-z0-9.]+:[a-z0-9.:]+\\])(?::\\d*)?(?:\\/(?:[a-z0-9\\-._~\\!$&\'*+,;=:@|]+|%[\\dA-F]{2})*)*(?:\\?(?:[a-z0-9\\-._~\\!$&\'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?(?:#(?:[a-z0-9\\-._~\\!$&\'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?)|(?:www\\.(?:[a-z0-9\\-._~\\!$&\'*+,;=:@|]+|%[\\dA-F]{2})+(?::\\d*)?(?:\\/(?:[a-z0-9\\-._~\\!$&\'*+,;=:@|]+|%[\\dA-F]{2})*)*(?:\\?(?:[a-z0-9\\-._~\\!$&\'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?(?:#(?:[a-z0-9\\-._~\\!$&\'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?)))','LINK':'([a-z0-9\-\./]+[^"\' ]*)','EMAIL':'((?:[\\w\!\#$\%\&\'\*\+\-\/\=\?\^\`{\|\}\~]+\.)*(?:[\\w\!\#$\%\'\*\+\-\/\=\?\^\`{\|\}\~]|&)+@(?:(?:(?:(?:(?:[a-z0-9]{1}[a-z0-9\-]{0,62}[a-z0-9]{1})|[a-z])\.)+[a-z]{2,6})|(?:\\d{1,3}\.){3}\\d{1,3}(?:\:\\d{1,5})?))','TEXT':'(.*?)','SIMPLETEXT':'([a-zA-Z0-9-+.,_ ]+)','INTTEXT':'([a-zA-Z0-9-+,_. ]+)','IDENTIFIER':'([a-zA-Z0-9-_]+)','COLOR':'([a-z]+|#[0-9abcdef]+)','NUMBER':'([0-9]+)'};var bbcode_matches=[];var html_tpls=[];var html_matches=[];var bbcode_tpls=[];var _getRegEx=function(str){var matches=str.match(token_match);var nrmatches=matches.length;var i=0;var replacement='';if(nrmatches<=0){return new RegExp(preg_quote(str),'g');}
for(;i<nrmatches;i+=1){var token=matches[i].replace(/[{}0-9]/g,'');if(tokens[token]){replacement+=preg_quote(str.substr(0,str.indexOf(matches[i])))+tokens[token];str=str.substr(str.indexOf(matches[i])+matches[i].length);}}
replacement+=preg_quote(str);return new RegExp(replacement,'gi');};var _getTpls=function(str){var matches=str.match(token_match);var nrmatches=matches.length;var i=0;var replacement='';var positions={};var next_position=0;if(nrmatches<=0){return str;}
for(;i<nrmatches;i+=1){var token=matches[i].replace(/[{}0-9]/g,'');var position;if(positions[matches[i]]){position=positions[matches[i]];}else{next_position+=1;position=next_position;positions[matches[i]]=position;}
if(tokens[token]){replacement+=str.substr(0,str.indexOf(matches[i]))+'$'+position;str=str.substr(str.indexOf(matches[i])+matches[i].length);}}
replacement+=str;return replacement;};me.addBBCode=function(bbcode_match,bbcode_tpl){bbcode_matches.push(_getRegEx(bbcode_match));html_tpls.push(_getTpls(bbcode_tpl));html_matches.push(_getRegEx(bbcode_tpl));bbcode_tpls.push(_getTpls(bbcode_match));};me.bbcodeToHtml=function(str){var nrbbcmatches=bbcode_matches.length;var i=0;for(;i<nrbbcmatches;i+=1){str=str.replace(bbcode_matches[i],html_tpls[i]);}
return str;};me.htmlToBBCode=function(str){var nrhtmlmatches=html_matches.length;var i=0;for(;i<nrhtmlmatches;i+=1){str=str.replace(html_matches[i],bbcode_tpls[i]);}
return str;}
function preg_quote(str,delimiter){return(str+'').replace(new RegExp('[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\'+(delimiter||'')+'-]','g'),'\\$&');}
me.addBBCode('[b]{TEXT}[/b]','<strong>{TEXT}</strong>');me.addBBCode('[i]{TEXT}[/i]','<em>{TEXT}</em>');me.addBBCode('[u]{TEXT}[/u]','<span style="text-decoration:underline;">{TEXT}</span>');me.addBBCode('[s]{TEXT}[/s]','<span style="text-decoration:line-through;">{TEXT}</span>');me.addBBCode('[url={URL}]{TEXT}[/url]','<a href="{URL}" title="link" target="_blank">{TEXT}</a>');me.addBBCode('[url]{URL}[/url]','<a href="{URL}" title="link" target="_blank">{URL}</a>');me.addBBCode('[url={LINK}]{TEXT}[/url]','<a href="{LINK}" title="link" target="_blank">{TEXT}</a>');me.addBBCode('[url]{LINK}[/url]','<a href="{LINK}" title="link" target="_blank">{LINK}</a>');me.addBBCode('[img={URL} width={NUMBER1} height={NUMBER2}]{TEXT}[/img]','<img src="{URL}" width="{NUMBER1}" height="{NUMBER2}" alt="{TEXT}" />');me.addBBCode('[img]{URL}[/img]',`<img src="{URL}" alt="{URL}" onerror="this.src='https://themes.trazk.com/chat/assets/no.svg'" />`);me.addBBCode('[img={LINK} width={NUMBER1} height={NUMBER2}]{TEXT}[/img]','<img src="{LINK}" width="{NUMBER1}" height="{NUMBER2}" alt="{TEXT}" />');me.addBBCode('[img]{LINK}[/img]','<img src="{LINK}" alt="{LINK}" />');me.addBBCode('[color=COLOR]{TEXT}[/color]','<span style="{COLOR}">{TEXT}</span>');me.addBBCode('[highlight={COLOR}]{TEXT}[/highlight]','<span style="background-color:{COLOR}">{TEXT}</span>');me.addBBCode('[quote="{TEXT1}"]{TEXT2}[/quote]','<div class="quote"><cite>{TEXT1}</cite><p>{TEXT2}</p></div>');me.addBBCode('[quote]{TEXT}[/quote]','<cite>{TEXT}</cite>');me.addBBCode('[blockquote]{TEXT}[/blockquote]','<blockquote>{TEXT}</blockquote>');me.addBBCode('[urlpreviewbox]{URL}[/urlpreviewbox]','<a href="{LINK}" title="link" target="_blank">{LINK}</a>');me.addBBCode('[button url="{URL}"]{TEXT}[/button]','<a target="_blank" href="{URL}" class="fff-button"><div class="label">{TEXT}</div></a>');me.addBBCode('[button url="{LINK}"]{TEXT}[/button]','<a target="_blank" href="{LINK}" class="fff-button"><div class="label">{TEXT}</div></a>');me.addBBCode('[button]{TEXT}[/button]','<div class="fff-button"><div class="label">{TEXT}</div></div>');};